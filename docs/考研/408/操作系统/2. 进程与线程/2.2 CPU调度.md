# 2.2 CPU调度

## 2.2.1 调度的概念

### 1. 调度的基本概念

在多道程序系统中，进程的数量往往多于 CPU 的个数，因此进程争用 CPU 的情况在所难免。CPU 调度是对 CPU 进行分配，即从就绪队列中按照一定的算法(公平、高效的原则)选择一个进程并将 CPU 分配给它运行，以实现进程并发地执行。

CPU 调度是多道程序操作系统的基础，是操作系统设计的核心问题。

### 2. 调度的层次

一个作业从提交开始直到完成，往往要经历以下三级调度

(1)高级调度(作业调度)

按照某种规则从外存上处于后备队列的作业中挑选一个(或多个),给它(们)分配内存、I/O 设备等必要的资源，并建立相应的进程，以使它(们)获得竞争 CPU 的权利。简言之，作业调度就是内存与辅存之间的调度。每个作业只调入一次、调出一次。多道批处理系统中大多配有作业调度，而其他系统中通常不需要配置作业调度。

(2)中级调度(内存调度)

引入中级调度的目的是提高内在利用率和系统吞叶量。为此，将那些暂时不能运行的讲程调至外存等待，此时进程的状态称为挂起态。当它们已具备运行条件且内存又稍有空闲时，由中级调度来决定将外存上的那些已具备运行条件的挂起进程再重新调入内存，并修改其状态为就绪态，挂在就绪队列上等待。中级调度实际上是存储器管理中的对换功能。

(3)低级调度(进程调度)

按照某种算法从就绪队列中选取一个进程，将 CPU 分配给它。进程调度是最基本的一种调
度，在各种操作系统中都必须配置这级调度。进程调度的频率很高，一般几十毫秒一次。

## 2.2.2 调度的实现

### 2.调度的时机、切换与过程

调度程序是操作系统内核程序。请求调度的事件发生后，才可能运行调度程序，调度了新的就绪进程后，才会进行进程切换。理论上这三件事情应该顺序执行，但在实际的操作系统内核程序运行中，若某时刻发生了引起进程调度的因素，则不一定能马上进行调度与切换。

命题追踪 可以进行 CPU 调度的事件或时机(2012、2021)

现代操作系统中，应该进行进程调度与切换的情况如下：

1. 创建新进程后，由于父进程和子进程都处于就绪态，因此需要决定是运行父进程还是运行子进程，调度程序可以合法地决定其中一个进程先运行。
2. 进程正常结束后或者异常终止后，必须从就绪队列中选择某个进程运行。若没有就绪进程，则通常运行一个系统提供的闲逛进程。
3. 当进程因 I/O 请求、信号量操作或其他原因而被阻塞时，必须调度其他进程运行。
4. 当 I/O 设备完成后，发出 I/O 中断，原先等待 I/O 的进程从阻塞态变为就绪态，此时需要决定是让新的就绪进程投入运行，还是让中断发生时运行的进程继续执行。

此外，在有些系统中，当有更紧急的任务(如更高优先级的进程进入就绪队列)需要处理时，
或者当前进程的时间片用完时，也被强行剥夺 CPU(被动放弃)。
进程切换往往在调度完成后立刻发生，它要求保存原进程当前断点的现场信息，恢复被调度进程的现场信息。现场切换时，操作系统内核将原进程的现场信息推入当前进程的内核堆栈来保存它们，并更新堆栈指针。内核完成从新进程的内核栈中装入新进程的现场信息、更新当前运行进程空间指针、重设 PC 寄存器等相关工作之后，开始运行新的进程。
不能进行进程的调度与切换的情况如下：

1. 在处理中断的过程中。中断处理过程复杂，在实现上很难做到进程切换，而且中断处理是系统工作的一部分，逻辑上不属于某一进程，不应被剥夺 CPU 资源。
2. 需要完全屏蔽中断的原子操作过程中。如加锁、解锁、中断现场保护、恢复等原子操作。在原子过程中，连中断都要屏蔽，更不应该进行进程调度与切换。若在上述过程中发生了引起调度的条件，则不能马上进行调度和切换，应置系统的请求调度标志，直到上述过程结束后才进行相应的调度与切换。

## 2.2.3 调度的目标

### CPU 利用率

$$\displaystyle\text{CPU的利用率}=\frac{\text{CPU有效工作时间}}{\text{CPU有效工作时间}+\text{CPU空闲等待时间}}$$

### 系统吞吐量

表示单位时间内 CPU 完成作业的数量。长作业需要消耗较长的 CPU 时间，
因此会降低系统的吞吐量。而对于短作业，需要消耗的 CPU 时间较短，因此能提高系统
的吞吐量。调度算法和方式的不同，也会对系统的吞吐量产生较大的影响。

### 周转时间

指从作业提交到作业完成所经历的时间，是作业等待、在就绪队列中排队、在 CPU 上运行及 I/O 操作所花费时间的总和。
周转时间的计算方法如下：

$$周转时间 = 作业完成时间 - 作业提交时间$$

平均周转时间是指多个作业周转时间的平均值：

$$平均周转时间=(作业1的周转时间+...+作业n的周转时间)/n$$

带权周转时间是指作业周转时间与作业实际运行时间的比值：

$$带权周转时间=\frac{\text{作业周转时间}}{\text{作业实际运行时间}}$$

平均带权周转时间是指多个作业带权周转时间的平均值：

$$平均带权周转时间 =(作业 1 的带权周转时间 +...+作业 n 的带权周转时间)/n$$

### 等待时间

指进程处于等待 CPU 的时间之和，等待时间越长，用户满意度越低。CPU 调度算法实际上并不影响作业执行或 I/O 操作的时间，只影响作业在就绪队列中等待所花的时间。因此，衡量一个调度算法的优劣，常常只需简单地考察等待时间。

### 响应时间

指从用户提交请求到系统首次产生响应所用的时间。在交互式系统中，周转时间不是最好的评价准则，一般采用响应时间作为衡量调度算法的重要准则之一。
从用户角度来看，调度策略应尽量降低响应时间，使响应时间处在用户能接受的范围之内。

## 2.2.5 典型的调度算法

1. FCFS(First Come First Served) 先进先出调度算法
2. SJF(Shortest Job First) 最短作业优先调度算法
3. HRRN(Highest Response Ratio Next) 最高响应比优先调度算法
4. Priority(Priority) 优先级调度算法
5. Round Robin(Round Robin) 轮转调度算法
6. MLFQ(Multi-Level Feedback Queue) 多级反馈队列调度算法
7. SRTF(Shortest Remaining Time First) 最短剩余时间优先调度算法

## 2.2.7 本节习题精选

错题：2、3、6、7、9、11、20、22、26、31、38、44
